<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Board</title>
  <script src="/auth.js"></script>
  <script>
    // 認証チェック - ログインしていなければリダイレクト
    if (!Auth.isLoggedIn()) {
      window.location.href = '/login.html?return=' + encodeURIComponent(window.location.pathname);
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      color: #1e293b;
    }
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .header p {
      font-size: 14px;
      color: #64748b;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
    }
    .doctors {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .doctor-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      text-decoration: none;
      color: inherit;
      transition: box-shadow 0.15s;
    }
    .doctor-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .avatar {
      width: 44px;
      height: 44px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .info {
      flex: 1;
    }
    .name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .id {
      font-size: 12px;
      color: #94a3b8;
    }
    .stats {
      display: flex;
      gap: 12px;
      text-align: center;
    }
    .stat-num {
      font-size: 18px;
      font-weight: 600;
    }
    .stat-num.pending { color: #f59e0b; }
    .stat-num.answered { color: #10b981; }
    .stat-label {
      font-size: 10px;
      color: #94a3b8;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }
    .refresh {
      display: block;
      margin: 20px auto 0;
      padding: 10px 20px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      color: #64748b;
      font-size: 13px;
      cursor: pointer;
    }
    .refresh:hover {
      background: #f8fafc;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Quick Board</h1>
    <p>担当医を選択</p>
    <button onclick="logout()" style="position:absolute;right:16px;top:50%;transform:translateY(-50%);padding:6px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;color:#64748b;font-size:12px;cursor:pointer;">ログアウト</button>
  </header>

  <div class="container">
    <div class="doctors" id="doctors">
      <div class="loading">読み込み中...</div>
    </div>
    <button class="refresh" onclick="load()">更新</button>
  </div>

  <script>
    const SUPABASE_URL = 'https://zumvtcckjvengyhtqlaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bXZ0Y2NranZlbmd5aHRxbGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MjE3ODUsImV4cCI6MjA4MDA5Nzc4NX0.tYn5Pl92THzT47aBzY8mWL3TT-gC0PGdId9ZWdYBJ7Q';

    async function load() {
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/save-question`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
          body: JSON.stringify({ action: 'get_questions' }),
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        const stats = {};
        (result.data || []).forEach(q => {
          if (!stats[q.doctor_id]) {
            stats[q.doctor_id] = { id: q.doctor_id, name: q.doctor_name, pending: 0, answered: 0 };
          }
          if (q.status === 'pending') stats[q.doctor_id].pending++;
          if (q.status === 'answered') stats[q.doctor_id].answered++;
        });

        render(Object.values(stats));
      } catch (e) {
        document.getElementById('doctors').innerHTML = `<div class="empty">${e.message}</div>`;
      }
    }

    function render(doctors) {
      if (doctors.length === 0) {
        document.getElementById('doctors').innerHTML = '<div class="empty">質問なし</div>';
        return;
      }
      doctors.sort((a, b) => b.pending - a.pending);
      document.getElementById('doctors').innerHTML = doctors.map(d => `
        <a href="/doctor/${d.id}" class="doctor-card">
          <div class="avatar">${(d.name || d.id).charAt(0)}</div>
          <div class="info">
            <div class="name">${d.name || d.id}</div>
            <div class="id">${d.id}</div>
          </div>
          <div class="stats">
            <div><div class="stat-num pending">${d.pending}</div><div class="stat-label">未対応</div></div>
            <div><div class="stat-num answered">${d.answered}</div><div class="stat-label">対応済</div></div>
          </div>
        </a>
      `).join('');
    }

    load();
    setInterval(load, 60000);

    function logout() {
      Auth.signOut();
      window.location.href = '/login.html';
    }
  </script>
</body>
</html>
