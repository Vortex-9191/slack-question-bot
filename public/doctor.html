<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>質問管理ボード</title>
  <script src="/auth.js"></script>
  <script>
    // 認証チェック - ログインしていなければリダイレクト
    if (!Auth.isLoggedIn()) {
      window.location.href = '/login.html?return=' + encodeURIComponent(window.location.pathname);
    } else {
      // 自分のdoctor_idと一致するかチェック
      const urlDoctorId = window.location.pathname.split('/').pop();
      const myDoctorId = Auth.getDoctorId();
      if (myDoctorId && urlDoctorId !== myDoctorId) {
        // 他人のページにアクセスしようとした場合、自分のページへリダイレクト
        window.location.href = '/doctor/' + myDoctorId;
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-900">

  <!-- Main Toolbar -->
  <div class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-10 shadow-sm">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-sm font-bold text-slate-800 flex items-center">
        <svg class="w-4 h-4 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        質問管理ボード
      </h2>
      <div class="flex gap-2">
        <button id="history-btn" class="flex items-center px-2 py-1 text-xs rounded border transition-colors bg-white text-slate-500 border-slate-200">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          対応履歴
        </button>
        <button onclick="logout()" class="flex items-center px-2 py-1 text-xs rounded border transition-colors bg-white text-slate-500 border-slate-200 hover:bg-slate-50">
          ログアウト
        </button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div id="filter-tabs" class="flex p-1 bg-slate-100 rounded-lg">
      <button id="filter-mine" class="flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium bg-white text-teal-700 shadow-sm">
        自分宛て
        <span id="my-badge" class="ml-1.5 bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
      </button>
      <button id="filter-all" class="flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium text-slate-500 hover:text-slate-700">
        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        すべての質問
      </button>
    </div>
  </div>

  <!-- Task List -->
  <div id="task-list" class="flex-1 overflow-y-auto p-3 space-y-3">
    <div class="flex flex-col items-center justify-center py-10 text-slate-400">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-slate-400"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://zumvtcckjvengyhtqlaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bXZ0Y2NranZlbmd5aHRxbGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MjE3ODUsImV4cCI6MjA4MDA5Nzc4NX0.tYn5Pl92THzT47aBzY8mWL3TT-gC0PGdId9ZWdYBJ7Q';

    const doctorId = window.location.pathname.split('/').pop();
    let allQuestions = [];
    let showHistory = false;
    let showAllDoctors = false;

    const taskList = document.getElementById('task-list');
    const historyBtn = document.getElementById('history-btn');
    const filterTabs = document.getElementById('filter-tabs');
    const filterMine = document.getElementById('filter-mine');
    const filterAll = document.getElementById('filter-all');
    const myBadge = document.getElementById('my-badge');

    historyBtn.onclick = () => {
      showHistory = !showHistory;
      if (showHistory) {
        historyBtn.className = 'flex items-center px-2 py-1 text-xs rounded border transition-colors bg-slate-700 text-white border-slate-700';
        historyBtn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>未対応へ戻る`;
        filterTabs.classList.add('hidden');
      } else {
        historyBtn.className = 'flex items-center px-2 py-1 text-xs rounded border transition-colors bg-white text-slate-500 border-slate-200';
        historyBtn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>対応履歴`;
        filterTabs.classList.remove('hidden');
      }
      render();
    };

    filterMine.onclick = () => {
      showAllDoctors = false;
      filterMine.className = 'flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium bg-white text-teal-700 shadow-sm';
      filterAll.className = 'flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium text-slate-500 hover:text-slate-700';
      render();
    };

    filterAll.onclick = () => {
      showAllDoctors = true;
      filterAll.className = 'flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium bg-white text-slate-800 shadow-sm';
      filterMine.className = 'flex-1 flex items-center justify-center py-1.5 text-xs rounded-md transition-all font-medium text-slate-500 hover:text-slate-700';
      render();
    };

    async function loadTasks() {
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/save-question`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
          body: JSON.stringify({ action: 'get_questions', doctorId }),
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        allQuestions = result.data || [];
        render();
      } catch (e) {
        taskList.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-slate-400"><p class="text-xs">${e.message}</p></div>`;
      }
    }

    function render() {
      // Count my pending
      const myPending = allQuestions.filter(q => q.status === 'pending').length;
      myBadge.textContent = myPending;
      myBadge.classList.toggle('hidden', myPending === 0);

      // Filter
      let list = allQuestions.filter(q => {
        const statusMatch = showHistory ? q.status === 'answered' : q.status === 'pending';
        return statusMatch;
      });

      if (list.length === 0) {
        taskList.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full text-slate-400 py-10">
            <svg class="w-12 h-12 mb-3 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p class="text-sm font-medium">${showHistory ? '履歴はありません' : '未対応はありません'}</p>
            ${!showHistory ? '<p class="text-xs opacity-60 mt-1">休憩しましょう</p>' : ''}
          </div>`;
        return;
      }

      taskList.innerHTML = list.map(q => {
        const isUrgent = q.question_type === 'urgent' || q.is_urgent;
        const time = q.created_at ? new Date(q.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '';
        const doctorName = q.doctor_name || q.doctor_id || '担当なし';

        if (showHistory) {
          const answer = (q.answers && q.answers[0]) ? q.answers[0].answer_content : '確認済み';
          return `
            <div class="bg-slate-50 rounded-lg border border-slate-200 p-3 opacity-70">
              <div class="flex justify-between mb-1">
                <span class="text-[10px] text-slate-400 flex items-center gap-1">
                  ${time}
                  <svg class="w-2 h-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                  ${esc(doctorName)}
                </span>
                <span class="text-[10px] bg-green-100 text-green-700 px-1 rounded border border-green-200">完了</span>
              </div>
              <p class="text-sm text-slate-600 mb-2">${esc(q.question_content)}</p>
              <div class="text-xs bg-white p-2 rounded border border-slate-100">
                <span class="font-bold text-teal-600 mr-1">回答:</span>${esc(answer)}
              </div>
            </div>`;
        }

        return `
          <div id="card-${q.question_id}" class="bg-white rounded-lg border shadow-sm transition-all duration-300 ${isUrgent ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-slate-300'}">
            <div class="p-3">
              <!-- Header -->
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-[10px] px-2 py-0.5 rounded font-medium bg-blue-100 text-blue-800">
                    To: ${esc(doctorName)}
                  </span>
                  ${isUrgent ? `<span class="flex items-center text-[10px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded border border-red-100"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>緊急</span>` : ''}
                </div>
                <span class="text-xs text-slate-400">${time}</span>
              </div>

              <!-- Question -->
              <div class="mb-3">
                <p class="text-xs text-slate-500 mb-0.5">患者質問:</p>
                <p class="text-sm text-slate-900 font-medium whitespace-pre-wrap leading-snug">${esc(q.question_content)}</p>
              </div>
              <div class="text-xs text-slate-400 mb-2">${esc(q.user_name || q.user_id)} · ${esc(q.patient_id)}</div>

              <!-- Actions -->
              <div class="flex flex-col gap-2 pt-2 border-t border-slate-100">
                <div class="flex gap-2">
                  <input id="input-${q.question_id}" type="text" placeholder="回答を入力して返信..." class="flex-1 bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 focus:bg-white outline-none transition-all">
                  <button onclick="customReply('${q.question_id}')" class="reply-btn px-3 py-1.5 rounded text-white text-xs font-bold shadow-sm flex items-center transition-colors bg-slate-400 hover:bg-slate-500" data-id="${q.question_id}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  </button>
                </div>

                <!-- Quick Chips -->
                <div class="flex gap-2 overflow-x-auto pb-1">
                  <button onclick="reply('${q.question_id}','次回診察時にお話しします')" class="whitespace-nowrap px-2 py-1 text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-200 transition-colors">次回診察時にお話しします</button>
                  <button onclick="reply('${q.question_id}','お薬手帳を持参ください')" class="whitespace-nowrap px-2 py-1 text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-200 transition-colors">お薬手帳を持参ください</button>
                  <button onclick="reply('${q.question_id}','電話で説明します')" class="whitespace-nowrap px-2 py-1 text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-200 transition-colors">電話で説明します</button>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');

      // Input listeners for button style change
      document.querySelectorAll('[id^="input-"]').forEach(input => {
        input.addEventListener('input', (e) => {
          const id = e.target.id.replace('input-', '');
          const btn = document.querySelector(`[data-id="${id}"]`);
          if (e.target.value) {
            btn.className = 'reply-btn px-3 py-1.5 rounded text-white text-xs font-bold shadow-sm flex items-center transition-colors bg-teal-600 hover:bg-teal-700';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
          } else {
            btn.className = 'reply-btn px-3 py-1.5 rounded text-white text-xs font-bold shadow-sm flex items-center transition-colors bg-slate-400 hover:bg-slate-500';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
          }
        });
      });
    }

    async function reply(id, msg) {
      const card = document.getElementById(`card-${id}`);
      if (card) card.classList.add('animate-pulse', 'opacity-50');
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/save-question`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
          body: JSON.stringify({ action: 'save_answer', questionId: id, answerContent: msg, answeredBy: doctorId, answeredByName: doctorId }),
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        await loadTasks();
      } catch (e) {
        alert('エラー: ' + e.message);
        if (card) card.classList.remove('animate-pulse', 'opacity-50');
      }
    }

    function customReply(id) {
      const input = document.getElementById(`input-${id}`);
      const msg = input.value.trim() || '回答しました';
      reply(id, msg);
    }

    function esc(t) {
      if (!t) return '';
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    loadTasks();
    setInterval(loadTasks, 30000);

    function logout() {
      Auth.signOut();
      window.location.href = '/login.html';
    }
  </script>
</body>
</html>
