# Slack Question Bot - 機能仕様書

## 概要

医療スタッフが医師に質問を送信し、医師が回答するSlackボットシステム。
質問・回答データはSupabaseに保存され、履歴管理が可能。

---

## 機能一覧

### 1. 質問送信機能
- ユーザーがSlackモーダルから質問を入力
- 患者ID、質問タイプ、担当医師、質問内容を指定
- 質問は担当医師のチャンネルに自動転送

### 2. 回答機能
- 医師が「回答する」ボタンで回答モーダルを開く
- 回答内容を入力して送信
- 回答は質問者と医師チャンネル両方に表示

### 3. 承認機能
- 医師が「承認する」ボタンで質問を承認
- 承認通知が質問者に送信

### 4. データ保存機能（Supabase連携）
- 全ての質問・回答がSupabaseに自動保存
- 履歴検索・分析が可能

---

## フロー図

### 質問〜回答フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           質問送信フロー                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   ユーザー    │     │  Slack Bot   │     │ 医師チャンネル │     │   Supabase   │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │                    │
       │ 1. /質問 コマンド   │                    │                    │
       │ ──────────────────>│                    │                    │
       │                    │                    │                    │
       │ 2. モーダル表示     │                    │                    │
       │ <──────────────────│                    │                    │
       │                    │                    │                    │
       │ 3. 質問入力・送信   │                    │                    │
       │ ──────────────────>│                    │                    │
       │                    │                    │                    │
       │                    │ 4. 質問データ保存   │                    │
       │                    │ ───────────────────────────────────────>│
       │                    │                    │                    │
       │                    │ 5. 医師チャンネルに │                    │
       │                    │    質問を転送       │                    │
       │                    │ ──────────────────>│                    │
       │                    │                    │                    │
       │ 6. 元チャンネルに   │                    │                    │
       │    確認メッセージ   │                    │                    │
       │ <──────────────────│                    │                    │
       │                    │                    │                    │


┌─────────────────────────────────────────────────────────────────────────────┐
│                           回答フロー                                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    医師      │     │  Slack Bot   │     │   ユーザー    │     │   Supabase   │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │                    │
       │ 1.「回答する」クリック│                    │                    │
       │ ──────────────────>│                    │                    │
       │                    │                    │                    │
       │ 2. 回答モーダル表示 │                    │                    │
       │ <──────────────────│                    │                    │
       │                    │                    │                    │
       │ 3. 回答入力・送信   │                    │                    │
       │ ──────────────────>│                    │                    │
       │                    │                    │                    │
       │                    │ 4. 回答データ保存   │                    │
       │                    │ ───────────────────────────────────────>│
       │                    │                    │                    │
       │                    │ 5. ユーザーに       │                    │
       │                    │    回答を送信       │                    │
       │                    │ ──────────────────>│                    │
       │                    │                    │                    │
       │ 6. 医師チャンネルの │                    │                    │
       │    スレッドに回答表示│                    │                    │
       │ <──────────────────│                    │                    │
       │                    │                    │                    │
       │ 7. ボタンを         │                    │                    │
       │   「回答済み」に更新 │                    │                    │
       │ <──────────────────│                    │                    │
       │                    │                    │                    │
```

---

## データフロー

### Supabase テーブル構造

#### questions テーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| question_id | TEXT | 質問の一意ID |
| patient_id | TEXT | 患者ID |
| question_type | TEXT | 質問タイプ（コード） |
| question_type_label | TEXT | 質問タイプ（表示名） |
| doctor_name | TEXT | 担当医師名 |
| doctor_id | TEXT | 担当医師ID |
| question_content | TEXT | 質問内容 |
| user_id | TEXT | 質問者のSlack ID |
| user_name | TEXT | 質問者名 |
| original_channel_id | TEXT | 質問元チャンネルID |
| original_message_ts | TEXT | 質問元メッセージTS |
| doctor_channel_id | TEXT | 医師チャンネルID |
| status | TEXT | ステータス (pending/answered/approved) |
| created_at | TIMESTAMPTZ | 作成日時 |
| updated_at | TIMESTAMPTZ | 更新日時 |

#### answers テーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| question_id | TEXT | 質問ID（外部キー） |
| answer_content | TEXT | 回答内容 |
| answered_by | TEXT | 回答者のSlack ID |
| answered_by_name | TEXT | 回答者名 |
| created_at | TIMESTAMPTZ | 作成日時 |

---

## API エンドポイント

### Supabase Edge Function: save-question

**URL:** `https://zumvtcckjvengyhtqlaf.supabase.co/functions/v1/save-question`

#### アクション一覧

| action | 説明 | 必須パラメータ |
|--------|------|---------------|
| `save_question` | 質問を保存 | questionId, patientId, questionType, doctorName, doctorId, questionContent, userId |
| `save_answer` | 回答を保存 | questionId, answerContent, answeredBy |
| `update_status` | ステータス更新 | questionId, status |
| `get_questions` | 質問一覧取得 | (任意) doctorId, status, limit |

#### リクエスト例

```json
// 質問保存
{
  "action": "save_question",
  "questionId": "U123456_1701590400000",
  "patientId": "P001",
  "questionType": "medication",
  "questionTypeLabel": "薬について",
  "doctorName": "山田太郎",
  "doctorId": "D001",
  "questionContent": "この薬の副作用について教えてください",
  "userId": "U123456",
  "userName": "田中花子"
}

// 回答保存
{
  "action": "save_answer",
  "questionId": "U123456_1701590400000",
  "answerContent": "この薬の主な副作用は...",
  "answeredBy": "U789012",
  "answeredByName": "山田太郎"
}
```

---

## 環境変数

### Render (slack-question-bot)

| 変数名 | 説明 |
|--------|------|
| `SLACK_BOT_TOKEN` | Slack Bot Token (xoxb-...) |
| `SLACK_SIGNING_SECRET` | Slack Signing Secret |
| `ADMIN_CHANNEL_ID` | 管理者チャンネルID |
| `SUPABASE_URL` | Supabase プロジェクトURL |
| `SUPABASE_ANON_KEY` | Supabase Anon Key |

---

## シーケンス図（詳細）

```
User          Slack           Bot            Doctor Ch       Supabase
 │              │               │                │               │
 │──/質問────────>│               │                │               │
 │              │──trigger_id──>│                │               │
 │              │<──modal───────│                │               │
 │<──modal──────│               │                │               │
 │              │               │                │               │
 │──submit──────>│               │                │               │
 │              │──payload──────>│                │               │
 │              │               │──save_question────────────────>│
 │              │               │<──success─────────────────────│
 │              │               │                │               │
 │              │               │──post_message─>│               │
 │              │               │                │ (質問表示)     │
 │              │               │                │ [回答][承認]   │
 │              │<──confirm─────│                │               │
 │<──confirm────│               │                │               │
 │              │               │                │               │
 │              │               │                │               │
 Doctor         │               │                │               │
 │              │               │                │               │
 │──「回答」クリック──────────────>│                │               │
 │              │               │──modal────────>│               │
 │<──modal──────│               │<───────────────│               │
 │              │               │                │               │
 │──submit──────>│               │                │               │
 │              │──payload──────>│                │               │
 │              │               │──save_answer──────────────────>│
 │              │               │<──success─────────────────────│
 │              │               │                │               │
 │              │               │──thread_reply─>│ (回答表示)     │
 │              │               │──update_msg───>│ (ボタン更新)   │
 │              │               │──notify_user──>│               │
 │              │<──────────────│               User             │
 │              │               │                │               │
```

---

## タスク管理ビュー（iframe埋め込み用）

### Supabase Edge Function: doctor-tasks-view

医師ごとの質問一覧をHTMLで返すEdge Function。iframeで埋め込み可能。

**ベースURL:** `https://zumvtcckjvengyhtqlaf.supabase.co/functions/v1/doctor-tasks-view`

### パラメータ

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `doctor_id` | 医師ID（任意）| `?doctor_id=yamada` |
| `status` | ステータスフィルタ | `?status=pending` |

### 使用例

```html
<!-- 全医師の質問一覧 -->
<iframe
  src="https://zumvtcckjvengyhtqlaf.supabase.co/functions/v1/doctor-tasks-view"
  width="100%"
  height="600"
  frameborder="0">
</iframe>

<!-- 特定医師（yamada）の対応待ち一覧 -->
<iframe
  src="https://zumvtcckjvengyhtqlaf.supabase.co/functions/v1/doctor-tasks-view?doctor_id=yamada&status=pending"
  width="100%"
  height="600"
  frameborder="0">
</iframe>
```

### 機能

- **統計表示**: 合計、対応待ち、回答済み、承認済みの件数
- **フィルタボタン**: ステータスで絞り込み
- **自動更新**: 30秒ごとに自動リロード
- **手動更新**: 右下の更新ボタン
- **レスポンシブ**: モバイル対応

### ビューイメージ

```
┌─────────────────────────────────────────────────┐
│ 📋 質問管理 - yamada                            │
├─────────────────────────────────────────────────┤
│ [合計: 15] [対応待ち: 3] [回答済み: 10] [承認: 2] │
├─────────────────────────────────────────────────┤
│ [すべて] [対応待ち] [回答済み] [承認済み]         │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ 患者ID: P001              [対応待ち]        │ │
│ │ 薬について                                  │ │
│ │ この薬の副作用について教えてください        │ │
│ │ 質問者: 田中花子    2024/12/03 09:15        │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ 患者ID: P002              [回答済み]        │ │
│ │ 検査結果について                            │ │
│ │ 血液検査の結果を確認したいです              │ │
│ │ 質問者: 佐藤太郎    2024/12/03 08:30        │ │
│ │ ─────────────────────────────────────────── │ │
│ │ 回答:                                       │ │
│ │ 検査結果は正常範囲内です...                 │ │
│ │ 回答者: 山田先生 | 2024/12/03 09:00         │ │
│ └─────────────────────────────────────────────┘ │
│                                           [🔄] │
└─────────────────────────────────────────────────┘
```

---

## 今後の拡張案

1. **リマインド機能** - 未回答質問の定期リマインド
2. **統計ダッシュボード** - 質問・回答の統計表示
3. **検索機能** - 過去の質問・回答を検索
4. **カテゴリ別レポート** - 質問タイプ別の集計
5. **エスカレーション** - 長時間未回答の自動エスカレーション


